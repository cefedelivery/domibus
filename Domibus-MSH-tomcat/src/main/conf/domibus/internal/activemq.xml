<?xml version="1.0" encoding="UTF-8"?>


<spring:beans
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:spring="http://www.springframework.org/schema/beans"
        xmlns:util="http://www.springframework.org/schema/util"
        xmlns:context="http://www.springframework.org/schema/context"
        xmlns="http://activemq.apache.org/schema/core"
        xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
  http://www.springframework.org/schema/util
  http://www.springframework.org/schema/util/spring-util.xsd">

    <context:property-placeholder properties-ref="domibusProperties" ignore-resource-not-found="true" ignore-unresolvable="true"/>

    <broker useJmx="true" brokerName="${activeMQ.brokerName}"  persistent="true" schedulerSupport="true" dataDirectory="${domibus.work.location:${domibus.config.location}}/work/activemq_data" tmpDataDirectory="${domibus.work.location:${domibus.config.location}}/temp">
        <managementContext>
            <managementContext createConnector="true" connectorPort="${activeMQ.connectorPort}" rmiServerPort="${activeMQ.rmiServerPort}"/>
        </managementContext>
        <transportConnectors>
            <transportConnector uri="${activeMQ.transportConnector.uri}" disableAsyncDispatch="true"/>
        </transportConnectors>
        <persistenceAdapter>
            <kahaDB directory="${domibus.work.location:${domibus.config.location}}/work/kahadb" />
        </persistenceAdapter>
        <systemUsage>
            <systemUsage>
                <memoryUsage>
                    <memoryUsage limit="64 mb" />
                </memoryUsage>
                <storeUsage>
                    <storeUsage limit="512 mb" />
                </storeUsage>
                <tempUsage>
                    <tempUsage limit="128 mb" />
                </tempUsage>
            </systemUsage>
        </systemUsage>
        <destinations>
            <queue id="sendMessageQueue"
                   physicalName="domibus.internal.dispatch.queue"/>
            <queue id="pullMessageQueue"
                   physicalName="domibus.internal.pull.queue"/>
            <!--queue id="notifyBackendQueue"
                   physicalName="domibus.internal.notification.queue"/-->
            <!-- If no backend with matching policy found notifcations are sent to this queue -->
            <queue id="unknownReceiverQueue"
                   physicalName="domibus.internal.notification.unknown"/>

            <!-- Backend plugin notification queues -->
            <queue id="webserviceBackendNotificationQueue"
                   physicalName="domibus.notification.webservice"/>
            <queue id="jmsBackendNotificationQueue"
                   physicalName="domibus.notification.jms"/>

            <queue id="notifyAdapterKerkoviQueue"
                   physicalName="domibus.notification.kerkovi"/>

            <!-- Internal queues of JMS backend plugin -->
            <queue id="jmsPluginToBackendQueue"
                       physicalName="domibus.backend.jms.replyQueue"/>
            <queue id="businessMessageOutQueue"
                       physicalName="domibus.backend.jms.outQueue"/>
            <queue id="businessMessageInQueue"
                   physicalName="domibus.backend.jms.inQueue"/>
            <queue id="errorNotifyConsumerQueue" physicalName="domibus.backend.jms.errorNotifyConsumer" />
            <queue id="errorNotifyProducerQueue" physicalName="domibus.backend.jms.errorNotifyProducer" />
            <queue id="domibusDLQ" physicalName="domibus.DLQ" />
            <topic id="clusterCommandTopic" physicalName="domibus.internal.command"/>

        </destinations>
        <destinationPolicy>
            <policyMap>
                <policyEntries>
                    <policyEntry queue=">">
                        <deadLetterStrategy>
                            <!--<individualDeadLetterStrategy queuePrefix="DLQ."/>-->
                            <sharedDeadLetterStrategy processExpired="false">
                                <deadLetterQueue>
                                    <queue physicalName="domibus.DLQ"/>
                                </deadLetterQueue>
                            </sharedDeadLetterStrategy>
                        </deadLetterStrategy>
                        <dispatchPolicy>
                            <roundRobinDispatchPolicy/>
                        </dispatchPolicy>
                    </policyEntry>
                </policyEntries>
            </policyMap>
        </destinationPolicy>

        <plugins>
            <simpleAuthenticationPlugin anonymousAccessAllowed="false">
                <users>
                    <authenticationUser username="${activeMQ.username}" password="${activeMQ.password}"
                                        groups="users"/>
                    <authenticationUser username="admin" password="123456" groups="admins,users" />
                </users>
            </simpleAuthenticationPlugin>
            <authorizationPlugin>
                <map>
                    <authorizationMap>
                        <authorizationEntries>
                            <authorizationEntry queue="domibus.>" read="users" write="users" admin="admins" />
                            <authorizationEntry topic="domibus.>" read="users" write="users" admin="admins"/>
                            <authorizationEntry topic="ActiveMQ.Advisory.>" read="users" write="users" admin="users"/>
                        </authorizationEntries>
                    </authorizationMap>
                </map>
            </authorizationPlugin>
            <redeliveryPlugin fallbackToDeadLetter="true"
                              sendToDlqIfMaxRetriesExceeded="true">
                <redeliveryPolicyMap>
                    <redeliveryPolicyMap>
                        <defaultEntry>
                            <!-- default policy-->
                            <redeliveryPolicy maximumRedeliveries="10" redeliveryDelay="300000"/>
                        </defaultEntry>
                        <redeliveryPolicyEntries>
                            <redeliveryPolicy queue="domibus.internal.dispatch.queue" maximumRedeliveries="0"/>
                            <redeliveryPolicy queue="domibus.internal.pull.queue" maximumRedeliveries="0"/>
                        </redeliveryPolicyEntries>
                    </redeliveryPolicyMap>
                </redeliveryPolicyMap>
            </redeliveryPlugin>
           <!--<loggingBrokerPlugin logAll="true" logConnectionEvents="false" logSessionEvents="false" perDestinationLogger="true"/>-->
            <!--spring:bean id="throughputLimiterPlugin" class="eu.domibus.messaging.amq.plugins.ThroughputLimiterPlugin">
                <spring:constructor-arg name="filter" ref="testFilter" />
                <spring:constructor-arg name="resendDelay" value="10000" />
            </spring:bean-->
            <discardingDLQBrokerPlugin dropOnly="domibus.internal.dispatch.queue" reportInterval="10000"/>
            <discardingDLQBrokerPlugin dropOnly="domibus.internal.pull.queue" reportInterval="10000"/>
        </plugins>
    </broker>

    <!--spring:bean id="testFilter" class="eu.domibus.messaging.amq.plugins.ThroughputFilter">
        <spring:property name="maxParallel" value="3" />
        <spring:property name="name" value="testFilter" />
        <spring:property name="queue" value="domibus.internal.dispatch.queue" />
        <spring:property name="propertyKey" value="#{T(eu.domibus.messaging.MessageConstants).ENDPOINT}" />
    </spring:bean-->




</spring:beans>